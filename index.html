<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Meetup RSVP</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        h1, h2, h3, .en-font { font-family: 'Poppins', 'Noto Sans KR', sans-serif; }
        
        /* Animations */
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Custom Inputs */
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #4f46e5; 
            box-shadow: 0 0 0 3px rgba(199, 210, 254, 0.5); 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20 relative min-h-screen">

    <!-- Root Container -->
    <div id="app"></div>

    <!-- Firebase Logic & App Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- Constants ---
        const ADMIN_PIN = 'wpxm123'; // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
        const ATTENDEES_COLLECTION = 'meetup_attendees_v2';
        const CONFIG_COLLECTION = 'meetup_config_v2';
        const CONFIG_DOC_ID = 'settings';

        // --- Global State ---
        const state = {
            user: null,
            attendees: [],
            // Default Config (Initial Fallback)
            meetupInfo: {
                clubName: "Jett's English Crew",
                meetupTitle: "Weekend English Discussion",
                meetupDesc: "ì¼ìƒ íšŒí™”ë¥¼ ë„˜ì–´ ê¹Šì´ ìˆëŠ” ì˜ì–´ í† ë¡ ì„ ì—°ìŠµí•˜ëŠ” ì¤‘ìƒê¸‰ ëª¨ì„ì…ë‹ˆë‹¤.",
                date: "2026ë…„ 2ì›” 8ì¼ (ì¼)",
                time: "10:00 AM - 12:00 PM",
                locationName: "íƒì•¤íƒìŠ¤ ì„±ì‹ ì—¬ëŒ€ì ",
                locationAddress: "ì„œìš¸ ì„±ë¶êµ¬ ë™ì†Œë¬¸ë¡œ22ê¸¸ 31 2ì¸µ",
                locationLink: "https://map.naver.com",
                
                // Curriculum
                part1Title: "Part 1. Ice Breaking",
                part1Duration: "40 min",
                p1Desc: "Small Talk & Article Reading",
                
                breakDesc: "Seat Change (10 min)",
                
                part2Title: "Part 2. Deep Discussion",
                part2Duration: "60 min",
                p2Desc: "Main Topic Discussion with new partners",
                
                // Topic
                topicTitle: "Technology & Future",
                session2Question: "Will AI replace human creativity in the future? Why or why not?",
                
                // Operational
                maxCapacity: 8,
                fee: "10,000",
                originalFee: "15,000",
                bankName: "ì¹´ì¹´ì˜¤ë±…í¬",
                bankAccount: "3333-26-2044919",
                accountHolder: "í™ê¸¸ë™",
                
                // Leader
                leaderName: "Jett",
                leaderBio: "ë°˜ê°‘ìŠµë‹ˆë‹¤! ë¦¬ë” Jettì…ë‹ˆë‹¤. ğŸ‘‹\nì € ë˜í•œ ì—¬ëŸ¬ë¶„ê³¼ í•¨ê»˜ ì„±ì¥í•´ê°€ëŠ” ì—°ìŠµìƒì…ë‹ˆë‹¤. í˜¸ì£¼ ì›Œí‚¹í™€ë¦¬ë°ì´ì™€ TESOL ê³¼ì •ì„ ê±°ì¹˜ë©° ë°°ìš´ ì†Œí†µì˜ ì¦ê±°ì›€ì„ ê³µìœ í•˜ê³  ì‹¶ì–´ìš”.\n\n'ì™„ë²½í•¨'ë³´ë‹¤ëŠ” 'ë‚˜ì˜ ìƒê°ì„ ì „ë‹¬í•˜ëŠ” ìš©ê¸°'ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤. 3ë…„ ë„˜ê²Œ ëª¨ì„ì„ ì´ëŒì–´ì˜¨ ê²½í—˜ìœ¼ë¡œ ì—¬ëŸ¬ë¶„ì´ í¸ì•ˆí•˜ê²Œ ì…ì„ ë—„ ìˆ˜ ìˆë„ë¡ ë„ì™€ë“œë¦´ê²Œìš”! ğŸŒâœ¨",
                leaderTags: "TESOL ìˆ˜ë£Œ, í˜¸ì£¼ ì›Œí‚¹í™€ë¦¬ë°ì´, ì„¸ê³„ì¼ì£¼, ì»¬ì»´ ë¦¬ë” 3ë…„+, TOEFL/IELTS ê²½í—˜",
                leaderImage: "https://api.dicebear.com/9.x/avataaars/svg?seed=Jett&backgroundColor=c0aede",
                
                // Messages
                drinkPolicy: "â˜• 1ì¸ 1ìŒë£Œ ì£¼ë¬¸ í•„ìˆ˜ (ê°œë³„ ê²°ì œ)",
                noticeMsg: "ëª¨ì„ ì‹œì‘ 10ë¶„ ì „ê¹Œì§€ ë„ì°©í•´ì£¼ì„¸ìš”!",

                // Etiquette
                etiquetteTitle: "í´ëŸ½ ì—í‹°ì¼“",
                etiquette1Title: "ğŸ‘‚ ê²½ì²­ê³¼ ì¡´ì¤‘", etiquette1Desc: "íƒ€ì¸ì´ ë°œì–¸í•  ë•ŒëŠ” í•¸ë“œí° ì‚¬ìš©ì„ ìì œí•˜ê³  ê·€ ê¸°ìš¸ì—¬ì£¼ì„¸ìš”. ë¬´ë¡€í•œ ì§ˆë¬¸ì€ ì‚¼ê°€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
                etiquette2Title: "â³ ê³µí‰í•œ ë°œì–¸ê¶Œ", etiquette2Desc: "í•œ ì‚¬ëŒì´ ëŒ€í™”ë¥¼ ë…ì í•˜ì§€ ì•Šë„ë¡ ë°°ë ¤í•´ì£¼ì„¸ìš”. (í•œ í„´ì— 2ë¶„ ë‚´ì™¸)",
                etiquette3Title: "ğŸš« ìˆœìˆ˜í•œ ëª©ì  ìœ ì§€", etiquette3Desc: "ì¢…êµ, ì˜ì—…, ì´ì„± êµì œ ìœ„ì£¼ì˜ í™œë™ì€ ì§€ì–‘í•˜ë©° ê°•í‡´ ì‚¬ìœ ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                
                // FAQ
                faq1Q: "ì£¼ì°¨ ê°€ëŠ¥í•œê°€ìš”?", faq1A: "íƒì•¤íƒìŠ¤ ê±´ë¬¼ ë‚´ ì£¼ì°¨ëŠ” ì¡°ê¸ˆ ì–´ë µìŠµë‹ˆë‹¤. ê·¼ì²˜ ê³µì˜ì£¼ì°¨ì¥ì„ ì´ìš©í•˜ì‹œê±°ë‚˜ ëŒ€ì¤‘êµí†µì„ ì´ìš©í•´ ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤!",
                faq2Q: "ì˜ì–´ê°€ ì„œíˆ´ëŸ¬ë„ ì°¸ì—¬í•  ìˆ˜ ìˆë‚˜ìš”?", faq2A: "ê·¸ëŸ¼ìš”! ì™„ë²½í•œ ë¬¸ë²•ë³´ë‹¤ëŠ” ì†Œí†µí•˜ë ¤ëŠ” ë§ˆìŒì´ ë” ì¤‘ìš”í•©ë‹ˆë‹¤. ë¦¬ë”ê°€ ê³ì—ì„œ ì¹œì ˆí•˜ê²Œ ë„ì™€ë“œë¦¬ë‹ˆ ê±±ì • ë§ˆì„¸ìš”.",
                faq3Q: "ì¤€ë¹„í•´ì•¼ í•  ê²ƒì´ ìˆì„ê¹Œìš”?", faq3A: "í•„ìš”í•œ í•™ìŠµ ìë£ŒëŠ” ì œê°€ ëª¨ë‘ ì¤€ë¹„í•´ ë“œë¦½ë‹ˆë‹¤. ê°€ë²¼ìš´ ë§ˆìŒê³¼ ê°œì¸ í•„ê¸°êµ¬ ì •ë„ë§Œ ì±™ê²¨ì˜¤ì‹œë©´ ì¶©ë¶„í•©ë‹ˆë‹¤!"
            },
            form: {
                name: '', nickname: '', contact: '', password: '', 
                englishLevel: 'mid', transferred: false, rememberMe: false
            },
            ui: {
                isAdmin: false,
                showAdminLogin: false,
                adminPinInput: '',
                loading: false,
                errorMsg: '',
                toast: null,
                
                // UI States
                showCurriculum: false, // Default hidden
                isLeaderExpanded: false,
                isCancelMode: false,
                activeFaq: null,
                
                // Modals
                modalConfig: null, // { title, message, onConfirm, isDestructive }
                showPasswordModal: false,
                targetDeleteId: null,
                cancelPasswordInput: '',
                
                // Editor
                isEditingInfo: false,
                activeSettingTab: 'basic', // basic, topic, leader, bank
                editForm: {} 
            },
            dDay: ''
        };

        // Make state globally available
        window.state = state;

        // --- Utilities ---
        window.updateState = (path, value) => {
            const keys = path.split('.');
            let obj = state;
            for (let i = 0; i < keys.length - 1; i++) obj = obj[keys[i]];
            obj[keys[keys.length - 1]] = value;
            window.render();
        };

        window.showToast = (message, type = 'success') => {
            state.ui.toast = { message, type };
            window.render();
            setTimeout(() => { state.ui.toast = null; window.render(); }, 3000);
        };

        window.copyText = (text) => {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            window.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        const calculateDDay = (dateStr) => {
            try {
                const cleanDate = dateStr.replace(/[^0-9]/g, " ");
                const parts = cleanDate.trim().split(/\s+/);
                if(parts.length < 3) return '';
                
                const target = new Date(parts[0], parts[1]-1, parts[2]);
                const today = new Date();
                target.setHours(0,0,0,0); today.setHours(0,0,0,0);
                
                const diff = (target - today) / (1000 * 60 * 60 * 24);
                if (diff < 0) return "End";
                if (diff === 0) return "Today";
                return `D-${Math.ceil(diff)}`;
            } catch { return ''; }
        };

        // --- Action Handlers ---
        window.handleAdminLogin = () => {
            if (state.ui.adminPinInput === ADMIN_PIN) {
                state.ui.isAdmin = true;
                state.ui.showAdminLogin = false;
                window.showToast('ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                window.showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }
        };

        window.handleApply = async (e) => {
            e.preventDefault();
            const { name, contact, password, transferred, englishLevel } = state.form;
            
            // Validation
            if (!name.trim()) return window.showToast('ì…ê¸ˆìëª…(ì‹¤ëª…)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            if (password.length < 4) return window.showToast('ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
            
            const currentCount = state.attendees.filter(a => a.status === 'approved' || (a.status === 'pending' && a.paid)).length;
            const maxCap = parseInt(state.meetupInfo.maxCapacity);
            const isWaitlist = currentCount >= maxCap;

            if (!isWaitlist && !transferred) return window.showToast('íšŒë¹„ ì…ê¸ˆ í›„ ì²´í¬í•´ì£¼ì„¸ìš”.', 'error');
            if (isWaitlist && !contact) return window.showToast('ëŒ€ê¸° ì—°ë½ì„ ìœ„í•´ ì—°ë½ì²˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'error');

            state.ui.loading = true;
            window.render();

            try {
                if (!state.user) {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION), {
                    ...state.form,
                    contact: contact || 'ë¹„ê³µê°œ',
                    status: isWaitlist ? 'waiting' : 'pending', // pending(ì…ê¸ˆí™•ì¸ì¤‘), approved(í™•ì •), waiting(ëŒ€ê¸°)
                    paid: !isWaitlist, // ëŒ€ê¸°ëŠ” ì…ê¸ˆ ì•ˆí•¨
                    isWaitlist,
                    createdAt: serverTimestamp(),
                    userId: auth.currentUser?.uid
                });

                // LocalStorage Logic
                if (state.form.rememberMe) {
                    localStorage.setItem('meetup_user', JSON.stringify({
                        name: state.form.name,
                        nickname: state.form.nickname,
                        contact: state.form.contact,
                        password: state.form.password,
                        englishLevel: state.form.englishLevel
                    }));
                }

                // Reset sensitive fields
                state.form.transferred = false;
                window.showToast(isWaitlist ? 'ëŒ€ê¸°ìë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ ì™„ë£Œ! ì…ê¸ˆ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.');
            } catch (err) {
                console.error(err);
                window.showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
            
            state.ui.loading = false;
            window.render();
        };

        // Admin Actions
        window.togglePaidStatus = async (id, currentStatus) => {
            if (!state.user || !state.ui.isAdmin) return;
            const newStatus = !currentStatus;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION, id), { 
                paid: newStatus,
                status: newStatus ? 'approved' : 'pending'
            });
            window.showToast(`ì…ê¸ˆ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };

        window.deleteAttendee = async (id) => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION, id));
            state.ui.modalConfig = null;
            state.ui.showPasswordModal = false;
            window.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        window.checkDeletePassword = () => {
            const target = state.attendees.find(a => a.id === state.ui.targetDeleteId);
            if (target && target.password === state.ui.cancelPasswordInput) {
                window.deleteAttendee(state.ui.targetDeleteId);
            } else {
                window.showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
            }
        };

        window.openSettings = () => {
            state.ui.editForm = JSON.parse(JSON.stringify(state.meetupInfo)); // Deep copy
            state.ui.isEditingInfo = true;
            window.render();
        };

        window.saveSettings = async () => {
            if (!state.user) return;
            state.ui.loading = true;
            window.render();
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', CONFIG_COLLECTION, CONFIG_DOC_ID), state.ui.editForm);
                state.ui.isEditingInfo = false;
                window.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                window.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
            
            state.ui.loading = false;
            window.render();
        };

        window.handleImageFile = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Check size (simple check, limit to ~500KB to be safe for firestore doc)
                    if (e.target.result.length > 800000) {
                        alert("ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (500KB ì´í•˜ ê¶Œì¥)");
                        return;
                    }
                    state.ui.editForm.leaderImage = e.target.result;
                    window.render();
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.downloadCSV = () => {
             const BOM = '\uFEFF';
             const headers = ['ì´ë¦„','ë‹‰ë„¤ì„','ì—°ë½ì²˜','ë ˆë²¨','ìƒíƒœ','ì…ê¸ˆì—¬ë¶€','ì‹ ì²­ì¼ì‹œ'];
             const rows = state.attendees.map(a => [
                 a.name, a.nickname, a.contact, a.englishLevel, a.status, a.paid?'O':'X', 
                 a.createdAt ? new Date(a.createdAt.seconds*1000).toLocaleDateString() : ''
             ].join(','));
             
             const blob = new Blob([BOM + headers.join(',') + '\n' + rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = `meetup_list_${new Date().toISOString().slice(0,10)}.csv`;
             link.click();
        };

        // --- Render Function ---
        function App() {
            const { meetupInfo, ui, attendees, form } = state;
            const validAttendees = attendees.filter(a => a.paid || a.status === 'approved');
            const currentCount = validAttendees.length;
            const maxCap = parseInt(meetupInfo.maxCapacity);
            const isFull = currentCount >= maxCap;

            // Helper for Tabs
            const TabButton = (id, label, icon) => `
                <button onclick="state.ui.activeSettingTab='${id}'; window.render()" 
                    class="flex-1 py-3 text-sm font-bold border-b-2 transition-colors flex items-center justify-center gap-1
                    ${ui.activeSettingTab === id ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-400 hover:text-slate-600'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i> ${label}
                </button>
            `;

            // Helper for Input Fields in Editor
            const EditInput = (label, key, type="text", placeholder="") => `
                <div class="mb-3">
                    <label class="block text-xs font-bold text-slate-500 mb-1">${label}</label>
                    ${type === 'textarea' 
                        ? `<textarea oninput="state.ui.editForm['${key}']=this.value" class="w-full p-2 border rounded text-sm h-20 bg-slate-50 focus:bg-white">${ui.editForm[key] || ''}</textarea>`
                        : `<input type="${type}" value="${ui.editForm[key] || ''}" oninput="state.ui.editForm['${key}']=this.value" placeholder="${placeholder}" class="w-full p-2 border rounded text-sm bg-slate-50 focus:bg-white">`
                    }
                </div>
            `;

            return `
                <!-- TOAST -->
                ${ui.toast ? `
                    <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] animate-in w-full max-w-sm px-4">
                        <div class="shadow-xl rounded-lg p-3 flex items-center justify-center gap-2 text-white text-sm font-bold ${ui.toast.type === 'error' ? 'bg-rose-500' : 'bg-indigo-600'}">
                            <i data-lucide="${ui.toast.type === 'error'?'alert-circle':'check-circle'}" class="w-4 h-4"></i>
                            ${ui.toast.message}
                        </div>
                    </div>
                ` : ''}

                <!-- HEADER -->
                <header class="bg-indigo-600 text-white pt-8 pb-12 px-6 shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-10 opacity-10 pointer-events-none">
                        <i data-lucide="message-circle" class="w-40 h-40"></i>
                    </div>
                    <div class="max-w-xl mx-auto relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <span class="inline-block bg-indigo-500/50 backdrop-blur text-xs font-bold px-2 py-1 rounded text-indigo-100 border border-indigo-400/30 mb-2">
                                ${meetupInfo.date}
                            </span>
                            ${ui.isAdmin ? `
                                <button onclick="window.openSettings()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors backdrop-blur-sm">
                                    <i data-lucide="settings" class="w-5 h-5 text-white"></i>
                                </button>
                            ` : ''}
                        </div>
                        <h1 class="text-3xl md:text-4xl font-black mb-2 leading-tight">${meetupInfo.clubName}</h1>
                        <p class="text-indigo-100 font-medium text-lg flex items-center gap-2 opacity-90">
                            ${state.dDay ? `<span class="bg-white text-indigo-600 text-xs font-bold px-1.5 py-0.5 rounded">${state.dDay}</span>` : ''}
                            ${meetupInfo.meetupTitle}
                        </p>
                    </div>
                </header>

                <!-- MAIN CONTENT -->
                <main class="max-w-xl mx-auto px-4 -mt-8 relative z-20 space-y-6 pb-10">
                    
                    <!-- INFO CARDS -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-1 flex divide-x divide-slate-100">
                        <div class="flex-1 p-3 flex flex-col items-center justify-center text-center">
                            <i data-lucide="clock" class="text-indigo-500 w-5 h-5 mb-1"></i>
                            <span class="text-xs text-slate-400 font-bold uppercase">Time</span>
                            <span class="text-sm font-bold text-slate-800 break-keep">${meetupInfo.time}</span>
                        </div>
                        <div class="flex-1 p-3 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-slate-50" onclick="window.open('${meetupInfo.locationLink}')">
                            <i data-lucide="map-pin" class="text-emerald-500 w-5 h-5 mb-1"></i>
                            <span class="text-xs text-slate-400 font-bold uppercase">Location</span>
                            <span class="text-sm font-bold text-slate-800 underline decoration-slate-200 underline-offset-2">${meetupInfo.locationName}</span>
                        </div>
                    </div>

                    <!-- LEADER SECTION (Redesigned) -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2">
                             <i data-lucide="award" class="w-5 h-5 text-indigo-600"></i>
                             <h2 class="font-bold text-lg text-indigo-900">Meet Your Host</h2>
                        </div>
                        <div class="p-6 flex flex-col md:flex-row gap-6">
                            <!-- Profile Card -->
                            <div class="w-full md:w-48 bg-slate-50 rounded-xl p-4 flex flex-col items-center border border-slate-100 shadow-sm shrink-0">
                                 <div class="w-24 h-24 md:w-32 md:h-32 rounded-lg overflow-hidden bg-white shadow-sm mb-3">
                                     <img src="${meetupInfo.leaderImage}" class="w-full h-full object-cover">
                                 </div>
                                 <div class="text-center">
                                     <h3 class="font-bold text-xl text-slate-800 mb-1">${meetupInfo.leaderName}</h3>
                                     <span class="inline-block bg-indigo-100 text-indigo-600 text-xs font-bold px-3 py-1 rounded-full">Host Leader</span>
                                 </div>
                            </div>
                            <!-- Bio & Tags -->
                            <div class="flex-1 space-y-4">
                                 <p class="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">${meetupInfo.leaderBio}</p>
                                 <div class="flex flex-wrap gap-2">
                                     ${meetupInfo.leaderTags.split(',').map(tag => `
                                         <span class="bg-white border border-slate-200 text-slate-600 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">
                                             ${tag.trim()}
                                         </span>
                                     `).join('')}
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- MERGED: TOPIC & CURRICULUM (Redesigned) -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2">
                             <i data-lucide="message-circle" class="w-5 h-5 text-indigo-600"></i>
                             <h2 class="font-bold text-lg text-indigo-900">ì˜¤ëŠ˜ì˜ ì£¼ì œ</h2>
                        </div>
                        <div class="p-5">
                            <div class="border border-slate-200 rounded-lg p-5 bg-white mb-4">
                                <h4 class="text-indigo-600 font-bold text-sm mb-1">Today's Topic</h4>
                                <p class="text-slate-800 font-medium italic">"${meetupInfo.session2Question}"</p>
                            </div>
                            
                            <button onclick="state.ui.showCurriculum = !state.ui.showCurriculum; window.render()" 
                                class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 px-4 rounded-lg flex items-center justify-between transition-colors">
                                <span class="flex items-center gap-2 text-sm"><i data-lucide="book-open" class="w-4 h-4"></i> ì§„í–‰ ë°©ì‹ ìì„¸íˆ ë³´ê¸°</span>
                                <i data-lucide="${ui.showCurriculum ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                            </button>
                            
                            ${ui.showCurriculum ? `
                                <div class="mt-4 px-3 space-y-4 text-sm animate-in border-l-2 border-indigo-100 ml-2 pl-4">
                                    <div class="pb-2">
                                        <p class="font-bold text-indigo-700">${meetupInfo.part1Title} <span class="text-xs font-normal text-slate-500">(${meetupInfo.part1Duration})</span></p>
                                        <p class="text-slate-600 text-xs mt-0.5">${meetupInfo.p1Desc}</p>
                                    </div>
                                    <div class="pb-2">
                                        <p class="font-bold text-amber-700">Break Time</p>
                                        <p class="text-slate-600 text-xs mt-0.5">${meetupInfo.breakDesc}</p>
                                    </div>
                                    <div>
                                        <p class="font-bold text-emerald-700">${meetupInfo.part2Title} <span class="text-xs font-normal text-slate-500">(${meetupInfo.part2Duration})</span></p>
                                        <p class="text-slate-600 text-xs mt-0.5">${meetupInfo.p2Desc}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- RSVP FORM -->
                    <section class="bg-white rounded-xl shadow-lg border-t-4 ${isFull ? 'border-orange-500' : 'border-indigo-600'} overflow-hidden">
                        <div class="p-5 pb-0">
                            <h3 class="text-xl font-bold flex items-center gap-2 mb-1">
                                <i data-lucide="check-square" class="${isFull ? 'text-orange-500' : 'text-indigo-600'}"></i> 
                                ${isFull ? 'ëŒ€ê¸° ì‹ ì²­ (Waitlist)' : 'ì°¸ê°€ ì‹ ì²­ (RSVP)'}
                            </h3>
                            <p class="text-xs text-slate-500 mb-4">${meetupInfo.noticeMsg}</p>
                            
                            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200 mb-4">
                                ${isFull ? 
                                    `<p class="text-orange-600 font-bold text-sm text-center">ğŸš« ì •ì› ë§ˆê°! ëŒ€ê¸°ìë¡œ ë“±ë¡ë©ë‹ˆë‹¤.</p>` : 
                                    `<div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-bold text-slate-600">ì°¸ê°€ë¹„</span>
                                        <div class="text-right">
                                            <span class="text-slate-400 line-through text-xs">${meetupInfo.originalFee}</span>
                                            <span class="text-rose-600 font-black text-lg">${meetupInfo.fee}ì›</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-end bg-white p-2 rounded border border-slate-100">
                                        <div class="text-xs text-slate-600">
                                            <div class="font-bold">${meetupInfo.bankName}</div>
                                            <div>${meetupInfo.bankAccount} (${meetupInfo.accountHolder})</div>
                                        </div>
                                        <button onclick="window.copyText('${meetupInfo.bankAccount}')" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold px-2 py-1 rounded transition-colors">ë³µì‚¬</button>
                                    </div>`
                                }
                            </div>
                        </div>

                        <form onsubmit="window.handleApply(event)" class="p-5 pt-2 space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">ì…ê¸ˆìëª… (ì‹¤ëª…)</label>
                                    <input type="text" value="${form.name}" oninput="state.form.name=this.value; window.render()" placeholder="í™ê¸¸ë™" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">ë‹‰ë„¤ì„ (ì˜ì–´)</label>
                                    <input type="text" value="${form.nickname}" oninput="state.form.nickname=this.value; window.render()" placeholder="Hong" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">ì˜ì–´ ë ˆë²¨ (Self-check)</label>
                                <select onchange="state.form.englishLevel=this.value; window.render()" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm">
                                    <option value="mid" ${form.englishLevel==='mid'?'selected':''}>ì¤‘ê¸‰ (ì¼ìƒ ëŒ€í™” ê°€ëŠ¥)</option>
                                    <option value="low" ${form.englishLevel==='low'?'selected':''}>ì´ˆì¤‘ê¸‰ (ë“£ê¸°ëŠ” ê°€ëŠ¥, ë§í•˜ê¸° ì—°ìŠµ í•„ìš”)</option>
                                    <option value="high" ${form.englishLevel==='high'?'selected':''}>ìƒê¸‰ (ììœ ë¡œìš´ í† ë¡  ê°€ëŠ¥)</option>
                                </select>
                            </div>

                            ${isFull ? `
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">ì—°ë½ì²˜ (í•„ìˆ˜)</label>
                                    <input type="tel" value="${form.contact}" oninput="state.form.contact=this.value; window.render()" placeholder="010-0000-0000" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm">
                                    <p class="text-[10px] text-orange-500 mt-1">* ê³µì„ ë°œìƒ ì‹œ ì—°ë½ë“œë¦´ ë²ˆí˜¸ì…ë‹ˆë‹¤.</p>
                                </div>
                            ` : ''}

                            <div class="flex items-center gap-2">
                                <label class="block text-xs font-bold text-slate-500 flex-1">ì‹ ì²­/ì·¨ì†Œ ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label>
                                <input type="tel" maxlength="4" value="${form.password}" oninput="state.form.password=this.value.replace(/[^0-9]/g,''); window.render()" placeholder="****" class="w-20 p-2.5 bg-slate-50 border rounded-lg text-center font-bold tracking-widest text-sm">
                            </div>

                            <div class="pt-2 space-y-2">
                                ${!isFull ? `
                                    <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded -ml-2">
                                        <input type="checkbox" ${form.transferred?'checked':''} onchange="state.form.transferred=this.checked; window.render()" class="accent-indigo-600 w-4 h-4">
                                        <span class="text-sm font-medium text-slate-700">ì°¸ê°€ë¹„ë¥¼ ì…ê¸ˆí–ˆìŠµë‹ˆë‹¤.</span>
                                    </label>
                                ` : ''}
                                <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded -ml-2">
                                    <input type="checkbox" ${form.rememberMe?'checked':''} onchange="state.form.rememberMe=this.checked; window.render()" class="accent-slate-500 w-4 h-4">
                                    <span class="text-xs text-slate-500">ë‹¤ìŒì—ë„ ë‚´ ì •ë³´ ê¸°ì–µí•˜ê¸°</span>
                                </label>
                            </div>

                            <button type="submit" disabled="${ui.loading}" class="w-full py-3.5 rounded-xl text-white font-bold shadow-md transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed ${isFull ? 'bg-orange-500 hover:bg-orange-600' : 'bg-indigo-600 hover:bg-indigo-700'}">
                                ${ui.loading ? 'ì²˜ë¦¬ ì¤‘...' : (isFull ? 'ëŒ€ê¸° ì‹ ì²­í•˜ê¸° (Waitlist)' : 'ì°¸ê°€ ì‹ ì²­í•˜ê¸° (Submit)')}
                            </button>
                        </form>
                    </section>

                    <!-- ATTENDEE LIST -->
                    <section>
                        <div class="flex justify-between items-center px-2 mb-3">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="users" class="w-4 h-4"></i> 
                                ì‹ ì²­ í˜„í™© <span class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded text-xs">${currentCount} / ${maxCap}</span>
                            </h3>
                            ${!ui.isAdmin ? `
                                <button onclick="state.ui.isCancelMode = !state.ui.isCancelMode; window.render()" class="text-xs font-bold px-2 py-1 rounded border ${ui.isCancelMode ? 'bg-slate-700 text-white' : 'bg-white text-slate-500'}">
                                    ${ui.isCancelMode ? 'ì™„ë£Œ' : 'ë‚´ ì‹ ì²­ ì·¨ì†Œ'}
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 divide-y divide-slate-100 mb-6">
                            ${attendees.length === 0 ? `<div class="p-8 text-center text-slate-400 text-sm">ì•„ì§ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë©¤ë²„ê°€ ë˜ì–´ì£¼ì„¸ìš”!</div>` : ''}
                            
                            ${attendees.map(user => {
                                const isMe = state.user?.uid === user.userId;
                                const isWaiting = user.isWaitlist;
                                return `
                                <div class="p-4 flex items-center justify-between group ${isWaiting ? 'bg-slate-50' : ''}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-9 h-9 rounded-full flex items-center justify-center font-bold text-sm shadow-sm border-2 border-white
                                            ${isWaiting ? 'bg-slate-200 text-slate-500' : 'bg-indigo-100 text-indigo-600'}">
                                            ${(user.nickname || user.name).charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <p class="text-sm font-bold text-slate-700 flex items-center gap-1">
                                                ${user.nickname || user.name}
                                                ${isMe ? '<span class="text-[9px] border border-indigo-200 text-indigo-500 px-1 rounded">ME</span>' : ''}
                                                ${isWaiting ? '<span class="text-[9px] bg-slate-200 text-slate-600 px-1 rounded">ëŒ€ê¸°</span>' : ''}
                                            </p>
                                            <p class="text-[10px] text-slate-400 flex items-center gap-1">
                                                ${user.paid 
                                                    ? '<span class="text-emerald-500 font-bold flex items-center"><i data-lucide="check" class="w-3 h-3"></i> í™•ì •ë¨</span>' 
                                                    : (isWaiting ? 'ì·¨ì†Œ ë°œìƒ ì‹œ ì—°ë½' : '<span class="text-amber-500">ì…ê¸ˆ í™•ì¸ ì¤‘</span>')}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-2">
                                        ${ui.isAdmin ? `
                                            <button onclick="window.togglePaidStatus('${user.id}', ${user.paid})" class="p-2 rounded hover:bg-slate-100 text-xs font-bold ${user.paid ? 'text-emerald-600' : 'text-slate-400'}">
                                                ${user.paid ? 'ì…ê¸ˆO' : 'ì…ê¸ˆX'}
                                            </button>
                                            <button onclick="state.ui.modalConfig={title:'ì‚­ì œ í™•ì¸',message:'${user.name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',onConfirm:()=>window.deleteAttendee('${user.id}'),isDestructive:true}; window.render()" class="p-2 text-slate-300 hover:text-red-500 transition-colors">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        ` : ''}
                                        
                                        ${(!ui.isAdmin && ui.isCancelMode && isMe) ? `
                                            <button onclick="state.ui.targetDeleteId='${user.id}'; state.ui.cancelPasswordInput=''; state.ui.showPasswordModal=true; window.render()" class="bg-rose-50 text-rose-600 text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-rose-100">
                                                ì‚­ì œ
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </section>
                    
                    <!-- ETIQUETTE & FAQ (Redesigned) -->
                    <section class="space-y-6">
                        <!-- Etiquette -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2">
                                <i data-lucide="shield-check" class="w-5 h-5 text-indigo-600"></i>
                                <h3 class="font-bold text-lg text-indigo-900">í´ëŸ½ ì—í‹°ì¼“</h3>
                            </div>
                            <div class="divide-y divide-slate-100">
                                <div class="p-5">
                                    <h4 class="font-bold text-slate-800 text-sm mb-1 flex items-center gap-2">ğŸ‘‚ ê²½ì²­ê³¼ ì¡´ì¤‘</h4>
                                    <p class="text-xs text-slate-500 leading-relaxed">${meetupInfo.etiquette1Desc}</p>
                                </div>
                                <div class="p-5">
                                    <h4 class="font-bold text-slate-800 text-sm mb-1 flex items-center gap-2">â³ ê³µí‰í•œ ë°œì–¸ê¶Œ</h4>
                                    <p class="text-xs text-slate-500 leading-relaxed">${meetupInfo.etiquette2Desc}</p>
                                </div>
                                <div class="p-5">
                                    <h4 class="font-bold text-slate-800 text-sm mb-1 flex items-center gap-2">ğŸš« ìˆœìˆ˜í•œ ëª©ì  ìœ ì§€</h4>
                                    <p class="text-xs text-slate-500 leading-relaxed">${meetupInfo.etiquette3Desc}</p>
                                </div>
                            </div>
                        </div>

                        <!-- FAQ -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2">
                                <i data-lucide="help-circle" class="w-5 h-5 text-indigo-600"></i>
                                <h3 class="font-bold text-lg text-indigo-900">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h3>
                            </div>
                            <div class="divide-y divide-slate-100">
                                ${[1,2,3].map(i => `
                                    <div>
                                        <button onclick="state.ui.activeFaq = state.ui.activeFaq === ${i} ? null : ${i}; window.render()" class="w-full p-4 text-left flex justify-between font-bold text-slate-700 hover:bg-slate-50 transition-colors">
                                            <span class="text-sm font-bold text-slate-800"><span class="text-indigo-600 mr-2 font-black">Q.</span>${meetupInfo[`faq${i}Q`]}</span>
                                            <i data-lucide="${ui.activeFaq === i ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 text-slate-400"></i>
                                        </button>
                                        ${ui.activeFaq === i ? `
                                            <div class="p-4 pt-0 text-sm text-slate-600 leading-relaxed bg-slate-50/50 animate-in pl-8">
                                                <span class="font-bold text-indigo-600 mr-2 font-black">A.</span>${meetupInfo[`faq${i}A`]}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </section>

                </main>

                <!-- FOOTER -->
                <footer class="text-center text-xs text-slate-300 pb-10">
                    <p class="mb-2">Â© 2026 ${meetupInfo.clubName}</p>
                    ${!ui.isAdmin ? `<button onclick="state.ui.showAdminLogin=true; window.render()" class="hover:text-slate-500">Admin Login</button>` : `<button onclick="location.reload()" class="text-indigo-400">Exit Admin</button>`}
                </footer>

                <!-- ================= MODALS ================= -->

                <!-- 1. ADMIN LOGIN -->
                ${ui.showAdminLogin ? `
                    <div class="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 animate-in">
                        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xs text-center">
                            <h3 class="font-bold text-lg mb-4">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
                            <input type="password" oninput="state.ui.adminPinInput=this.value" class="w-full p-3 border rounded-lg text-center tracking-widest text-xl mb-4" placeholder="PIN" autofocus>
                            <div class="flex gap-2">
                                <button onclick="state.ui.showAdminLogin=false; window.render()" class="flex-1 py-2 bg-slate-100 rounded-lg font-bold">ì·¨ì†Œ</button>
                                <button onclick="window.handleAdminLogin()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-bold">í™•ì¸</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- 2. USER DELETE PASSWORD -->
                ${ui.showPasswordModal ? `
                    <div class="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 animate-in">
                        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xs">
                            <h3 class="font-bold text-lg mb-2">ì‹ ì²­ ì·¨ì†Œ</h3>
                            <p class="text-xs text-slate-500 mb-4">ì‹ ì²­ ì‹œ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                            <input type="tel" maxlength="4" oninput="state.ui.cancelPasswordInput=this.value" class="w-full p-3 border rounded-lg text-center tracking-widest text-xl mb-4" autofocus placeholder="****">
                            <div class="flex gap-2">
                                <button onclick="state.ui.showPasswordModal=false; window.render()" class="flex-1 py-2 bg-slate-100 rounded-lg font-bold">ë‹«ê¸°</button>
                                <button onclick="window.checkDeletePassword()" class="flex-1 py-2 bg-rose-500 text-white rounded-lg font-bold">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- 3. CONFIRMATION MODAL -->
                ${ui.modalConfig ? `
                    <div class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 animate-in">
                        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                            <h3 class="font-bold text-lg mb-2">${ui.modalConfig.title}</h3>
                            <p class="text-sm text-slate-600 mb-6">${ui.modalConfig.message}</p>
                            <div class="flex gap-2">
                                <button onclick="state.ui.modalConfig=null; window.render()" class="flex-1 py-2 bg-slate-100 rounded-lg font-bold">ì·¨ì†Œ</button>
                                <button onclick="state.ui.modalConfig.onConfirm()" class="flex-1 py-2 text-white rounded-lg font-bold ${ui.modalConfig.isDestructive?'bg-rose-500':'bg-indigo-600'}">í™•ì¸</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- 4. FULL SETTINGS EDITOR (ADMIN) -->
                ${ui.isEditingInfo ? `
                    <div class="fixed inset-0 bg-slate-100 z-[80] flex flex-col animate-slide-up">
                        <div class="bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm">
                            <h3 class="font-bold text-lg">ëª¨ì„ ì„¤ì • ìˆ˜ì •</h3>
                            <button onclick="state.ui.isEditingInfo=false; window.render()" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        
                        <div class="flex bg-white border-b sticky top-0 z-10">
                            ${TabButton('basic', 'ê¸°ë³¸', 'calendar')}
                            ${TabButton('topic', 'ì£¼ì œ', 'message-circle')}
                            ${TabButton('leader', 'ë¦¬ë”', 'user')}
                            ${TabButton('bank', 'ìš´ì˜', 'credit-card')}
                        </div>

                        <div class="flex-1 overflow-y-auto p-5 pb-24">
                            ${ui.activeSettingTab === 'basic' ? `
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                                    <h4 class="font-bold text-indigo-600 mb-3 text-sm border-b pb-2">ê¸°ë³¸ ì •ë³´</h4>
                                    ${EditInput('ëª¨ì„ ì´ë¦„ (Club Name)', 'clubName')}
                                    ${EditInput('ëª¨ì„ íƒ€ì´í‹€', 'meetupTitle')}
                                    ${EditInput('ë‚ ì§œ (ì˜ˆ: 2026ë…„ 2ì›” 8ì¼)', 'date')}
                                    ${EditInput('ì‹œê°„', 'time')}
                                </div>
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                    <h4 class="font-bold text-emerald-600 mb-3 text-sm border-b pb-2">ì¥ì†Œ ì •ë³´</h4>
                                    ${EditInput('ì¥ì†Œëª…', 'locationName')}
                                    ${EditInput('ì£¼ì†Œ', 'locationAddress')}
                                    ${EditInput('ì§€ë„ ë§í¬ (URL)', 'locationLink')}
                                </div>
                            ` : ''}

                            ${ui.activeSettingTab === 'topic' ? `
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                                    <h4 class="font-bold text-indigo-600 mb-3 text-sm border-b pb-2">ë©”ì¸ í† ë¡  ì£¼ì œ</h4>
                                    ${EditInput('ì£¼ì œ íƒ€ì´í‹€ (ì˜ˆ: Travel)', 'topicTitle')}
                                    ${EditInput('í† ë¡  ì§ˆë¬¸ (ì „ì²´ ë¬¸ì¥)', 'session2Question', 'textarea')}
                                </div>
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                    <h4 class="font-bold text-slate-600 mb-3 text-sm border-b pb-2">ì»¤ë¦¬í˜ëŸ¼ ìƒì„¸</h4>
                                    ${EditInput('Part 1 ì œëª©', 'part1Title')}
                                    ${EditInput('Part 1 ì„¤ëª…', 'p1Desc')}
                                    ${EditInput('Part 2 ì œëª©', 'part2Title')}
                                    ${EditInput('Part 2 ì„¤ëª…', 'p2Desc')}
                                </div>
                            ` : ''}

                            ${ui.activeSettingTab === 'leader' ? `
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                    <h4 class="font-bold text-indigo-600 mb-3 text-sm border-b pb-2">í˜¸ìŠ¤íŠ¸ ì •ë³´</h4>
                                    ${EditInput('ë¦¬ë” ì´ë¦„', 'leaderName')}
                                    ${EditInput('ë¦¬ë” ì†Œê°œ', 'leaderBio', 'textarea')}
                                    ${EditInput('ë¦¬ë” íƒœê·¸ (ì½¤ë§ˆë¡œ êµ¬ë¶„)', 'leaderTags')} <!-- Added Leader Tags Input -->
                                    <div class="mb-3">
                                        <label class="block text-xs font-bold text-slate-500 mb-1">ë¦¬ë” ì´ë¯¸ì§€</label>
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-full bg-slate-100 overflow-hidden border">
                                                <img src="${ui.editForm.leaderImage}" class="w-full h-full object-cover">
                                            </div>
                                            <div class="flex-1">
                                                <input type="text" value="${ui.editForm.leaderImage}" oninput="state.ui.editForm.leaderImage=this.value; window.render()" class="w-full p-2 border rounded text-xs mb-1" placeholder="ì´ë¯¸ì§€ URL ì…ë ¥">
                                                <input type="file" onchange="window.handleImageFile(this)" class="text-xs text-slate-500">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${ui.activeSettingTab === 'bank' ? `
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                                    <h4 class="font-bold text-indigo-600 mb-3 text-sm border-b pb-2">ê³„ì¢Œ ë° íšŒë¹„</h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        ${EditInput('ì€í–‰ëª…', 'bankName')}
                                        ${EditInput('ì˜ˆê¸ˆì£¼', 'accountHolder')}
                                    </div>
                                    ${EditInput('ê³„ì¢Œë²ˆí˜¸', 'bankAccount')}
                                    <div class="grid grid-cols-2 gap-3">
                                        ${EditInput('í• ì¸ íšŒë¹„', 'fee')}
                                        ${EditInput('ì •ê°€(ì·¨ì†Œì„ )', 'originalFee')}
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                                    <h4 class="font-bold text-indigo-600 mb-3 text-sm border-b pb-2">ê¸°íƒ€ ì„¤ì •</h4>
                                    ${EditInput('ìµœëŒ€ ì •ì› (ìˆ«ì)', 'maxCapacity', 'number')}
                                    ${EditInput('ìŒë£Œ ì •ì±… ì•ˆë‚´', 'drinkPolicy')}
                                    ${EditInput('ìƒë‹¨ ê³µì§€ ë©”ì‹œì§€', 'noticeMsg')}
                                </div>
                                <button onclick="window.downloadCSV()" class="w-full py-3 border-2 border-emerald-500 text-emerald-600 font-bold rounded-lg flex items-center justify-center gap-2">
                                    <i data-lucide="download"></i> ì°¸ê°€ì ëª…ë‹¨ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                                </button>
                            ` : ''}
                        </div>

                        <div class="p-4 bg-white border-t flex gap-3">
                            <button onclick="state.ui.isEditingInfo=false; window.render()" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl">ì·¨ì†Œ</button>
                            <button onclick="window.saveSettings()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">ì €ì¥í•˜ê¸°</button>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // --- Init ---
        let listenersInitialized = false;

        const startListeners = () => {
            if (listenersInitialized) return;
            listenersInitialized = true;

            // Meetup Info Listener
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', CONFIG_COLLECTION, CONFIG_DOC_ID), (snap) => {
                if (snap.exists()) {
                    state.meetupInfo = { ...state.meetupInfo, ...snap.data() };
                    state.dDay = calculateDDay(state.meetupInfo.date);
                    window.render();
                }
            }, (error) => console.error("Config Listener Error:", error));

            // Attendees Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION), (snap) => {
                const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                // Sort: Approved first, then by time
                state.attendees = data.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                window.render();
            }, (error) => console.error("Attendees Listener Error:", error));
        };

        const init = async () => {
            // Load LocalStorage
            const saved = localStorage.getItem('meetup_user');
            if (saved) state.form = { ...state.form, ...JSON.parse(saved), rememberMe: true };

            window.render = () => {
                const appEl = document.getElementById('app');
                if (appEl) appEl.innerHTML = App();
                if (window.lucide) lucide.createIcons();
            };

            // Setup Auth State Listener First
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                window.render();
                
                // Only start data listeners if user is authenticated
                if (user) {
                    startListeners();
                }
            });

            // Trigger Auth
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth Init Error:", e);
            }
        };

        init();
    </script>
</body>
</html>
