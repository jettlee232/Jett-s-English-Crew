<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Meetup RSVP</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Focus state helper */
        input:focus, textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20 relative min-h-screen">

    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, serverTimestamp, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error (Check Config):", e);
        }

        // --- Global State ---
        const state = {
            user: null,
            attendees: [],
            meetupInfo: {
                // Default Initial State
                clubName: "Jett's English Crew",
                meetupTitle: "ì„±ë¶ ì¤‘ìƒê¸‰ ì˜ì–´íšŒí™” & í† ë¡ ",
                meetupDesc: "ì¼ìƒ íšŒí™”ë¥¼ ììœ ë¡­ê²Œ êµ¬ì‚¬í•˜ëŠ” ê²ƒì„ ë„˜ì–´ì„œ ë” ê¹Šì´ ìˆëŠ” ì˜ì–´ í† ë¡ ì„ ì—°ìŠµí•˜ëŠ” ì¤‘ìƒê¸‰ ëª¨ì„ì…ë‹ˆë‹¤.",
                date: "2026ë…„ 2ì›” 1ì¼ (ì¼)",
                time: "ì˜¤ì „ 10:00 - 12:00",
                locationName: "íƒì•¤íƒìŠ¤ ì„±ì‹ ì—¬ëŒ€ì ",
                locationAddress: "ì„œìš¸ ì„±ë¶êµ¬ ë™ì†Œë¬¸ë¡œ22ê¸¸ 31",
                locationLink: "https://map.naver.com/v5/search/íƒì•¤íƒìŠ¤%20ì„±ì‹ ì—¬ëŒ€ì ",
                part1Title: "Part 1. Warm-up & Session 1",
                part1Duration: "50 min",
                p1Time1: "20'", p1Title1: "Small Talk", p1Desc1: "ê°€ë²¼ìš´ ì£¼ì œë¡œ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ë©° ë¶„ìœ„ê¸° ì¡°ì„±",
                p1Time2: "30'", p1Title2: "Reading & Discussion 1", p1Desc2: "ì‹¬í™” ì§€ë¬¸ ë…í•´ ë° ì²« ë²ˆì§¸ ì§ˆë¬¸ í† ë¡ ",
                p1Time3: "", p1Title3: "", p1Desc3: "",
                breakTitle: "Break (10 min)",
                breakDesc: "Seat Change: ìƒˆë¡œìš´ íŒŒíŠ¸ë„ˆì™€ ë§¤ì¹­",
                part2Title: "Part 2. Session 2 & Wrap-up",
                part2Duration: "50 min",
                p2Time1: "10'", p2Title1: "Refresh Talk", p2Desc1: "ìƒˆ íŒŒíŠ¸ë„ˆì™€ ì¸ì‚¬ ë° ê°€ë²¼ìš´ ìŠ¤ëª°í†¡",
                p2Time2: "30'", p2Title2: "Reading & Discussion 2", p2Desc2: "ë‘ ë²ˆì§¸ ì§ˆë¬¸ì— ëŒ€í•œ ì˜ê²¬ êµí™˜ ë° ì‹¬í™” ëŒ€í™”",
                p2Time3: "10'", p2Title3: "Closing", p2Desc3: "ì˜¤ëŠ˜ì˜ í•µì‹¬ ë¬¸ì¥ ë¦¬ë§ˆì¸ë“œ ë° ë§ˆë¬´ë¦¬",
                topicTitle: "Travel & Adventure",
                session2Topic: "Travel Styles",
                session2Question: "Do you prefer planning every detail of a trip or being spontaneous? What are the pros and cons?",
                maxCapacity: 8,
                fee: "1,000",
                originalFee: "3,000",
                drinkPolicy: "â˜• ê°œì¸ ìŒë£ŒëŠ” ë³„ë„ë¡œ ì£¼ë¬¸í•´ì£¼ì„¸ìš” (1ì¸ 1ë©”ë‰´)",
                bankName: "ì¹´ì¹´ì˜¤ë±…í¬",
                bankAccount: "3333-26-2044919",
                accountHolder: "í™ê¸¸ë™",
                leaderName: "Jett",
                leaderImage: "https://api.dicebear.com/9.x/avataaars/svg?seed=Jett&backgroundColor=c0aede",
                leaderBio: "ë°˜ê°‘ìŠµë‹ˆë‹¤! ë¦¬ë” Jettì…ë‹ˆë‹¤. ğŸ‘‹\nì € ë˜í•œ ì—¬ëŸ¬ë¶„ê³¼ í•¨ê»˜ ì„±ì¥í•´ê°€ëŠ” ì—°ìŠµìƒì…ë‹ˆë‹¤. í˜¸ì£¼ ì›Œí‚¹í™€ë¦¬ë°ì´ì™€ TESOL ê³¼ì •ì„ ê±°ì¹˜ë©° ë°°ìš´ ì†Œí†µì˜ ì¦ê±°ì›€ì„ ê³µìœ í•˜ê³  ì‹¶ì–´ìš”.\n\n'ì™„ë²½í•¨'ë³´ë‹¤ëŠ” 'ë‚˜ì˜ ìƒê°ì„ ì „ë‹¬í•˜ëŠ” ìš©ê¸°'ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤. 3ë…„ ë„˜ê²Œ ëª¨ì„ì„ ì´ëŒì–´ì˜¨ ê²½í—˜ìœ¼ë¡œ ì—¬ëŸ¬ë¶„ì´ í¸ì•ˆí•˜ê²Œ ì…ì„ ë—„ ìˆ˜ ìˆë„ë¡ ë„ì™€ë“œë¦´ê²Œìš”! ğŸŒâœ¨",
                leaderTags: "TESOL ìˆ˜ë£Œ, í˜¸ì£¼ ì›Œí‚¹í™€ë¦¬ë°ì´, ì„¸ê³„ì¼ì£¼, ì»¬ì»´ ë¦¬ë” 3ë…„+, TOEFL/IELTS ê²½í—˜",
                etiquetteTitle: "í´ëŸ½ ì—í‹°ì¼“",
                etiquette1Title: "ğŸ‘‚ ê²½ì²­ê³¼ ì¡´ì¤‘", etiquette1Desc: "íƒ€ì¸ì´ ë°œì–¸í•  ë•ŒëŠ” í•¸ë“œí° ì‚¬ìš©ì„ ìì œí•˜ê³  ê·€ ê¸°ìš¸ì—¬ì£¼ì„¸ìš”. ë¬´ë¡€í•œ ì§ˆë¬¸ì€ ì‚¼ê°€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
                etiquette2Title: "â³ ê³µí‰í•œ ë°œì–¸ê¶Œ", etiquette2Desc: "í•œ ì‚¬ëŒì´ ëŒ€í™”ë¥¼ ë…ì í•˜ì§€ ì•Šë„ë¡ ë°°ë ¤í•´ì£¼ì„¸ìš”. (í•œ í„´ì— 2ë¶„ ë‚´ì™¸)",
                etiquette3Title: "ğŸš« ìˆœìˆ˜í•œ ëª©ì  ìœ ì§€", etiquette3Desc: "ì¢…êµ, ì˜ì—…, ì´ì„± êµì œ ìœ„ì£¼ì˜ í™œë™ì€ ì§€ì–‘í•˜ë©° ê°•í‡´ ì‚¬ìœ ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                openChatLink: "#",
                faq1Q: "ì£¼ì°¨ ê°€ëŠ¥í•œê°€ìš”?", faq1A: "íƒì•¤íƒìŠ¤ ê±´ë¬¼ ë‚´ ì£¼ì°¨ëŠ” ì¡°ê¸ˆ ì–´ë µìŠµë‹ˆë‹¤. ê·¼ì²˜ ê³µì˜ì£¼ì°¨ì¥ì„ ì´ìš©í•˜ì‹œê±°ë‚˜ ëŒ€ì¤‘êµí†µì„ ì´ìš©í•´ ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤!",
                faq2Q: "ì˜ì–´ê°€ ì„œíˆ´ëŸ¬ë„ ì°¸ì—¬í•  ìˆ˜ ìˆë‚˜ìš”?", faq2A: "ê·¸ëŸ¼ìš”! ì™„ë²½í•œ ë¬¸ë²•ë³´ë‹¤ëŠ” ì†Œí†µí•˜ë ¤ëŠ” ë§ˆìŒì´ ë” ì¤‘ìš”í•©ë‹ˆë‹¤. ë¦¬ë”ê°€ ê³ì—ì„œ ì¹œì ˆí•˜ê²Œ ë„ì™€ë“œë¦¬ë‹ˆ ê±±ì • ë§ˆì„¸ìš”.",
                faq3Q: "ì¤€ë¹„í•´ì•¼ í•  ê²ƒì´ ìˆì„ê¹Œìš”?", faq3A: "í•„ìš”í•œ í•™ìŠµ ìë£ŒëŠ” ì œê°€ ëª¨ë‘ ì¤€ë¹„í•´ ë“œë¦½ë‹ˆë‹¤. ê°€ë²¼ìš´ ë§ˆìŒê³¼ ê°œì¸ í•„ê¸°êµ¬ ì •ë„ë§Œ ì±™ê²¨ì˜¤ì‹œë©´ ì¶©ë¶„í•©ë‹ˆë‹¤!"
            },
            form: {
                name: '', nickname: '', contact: '', password: '', gender: 'female', englishLevel: 'mid', transferred: false, rememberMe: false
            },
            ui: {
                isAdmin: false,
                showAdminLogin: false,
                adminPinInput: '',
                loading: false,
                errorMsg: '',
                toast: null,
                activeFaq: null,
                activeEtiquette: null,
                showCurriculum: false,
                isLeaderExpanded: false,
                modalConfig: null,
                isCancelMode: false,
                showPasswordModal: false,
                cancelPasswordInput: '',
                targetDeleteId: null,
                isEditingInfo: false,
                editForm: {},
                expandedSections: { header: true }
            },
            dDay: ''
        };

        // Make functions globally available for inline HTML events
        window.state = state;

        const ADMIN_PIN = 'wpxm123';
        const ATTENDEES_COLLECTION = 'english_meetup_attendees';
        const CONFIG_COLLECTION = 'english_meetup_config';
        const CONFIG_DOC_ID = 'meetup_info';

        // --- Core UI Functions ---
        window.render = function() {
            const appEl = document.getElementById('app');
            appEl.innerHTML = App();
            lucide.createIcons();
            
            const fileInput = document.getElementById('leaderImageInput');
            if(fileInput) {
                fileInput.addEventListener('change', window.handleImageUpload);
            }
        };

        window.updateState = function(path, value) {
            const keys = path.split('.');
            let obj = state;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!obj[keys[i]]) obj[keys[i]] = {};
                obj = obj[keys[i]];
            }
            obj[keys[keys.length - 1]] = value;
            window.render();
        };
        
        window.updateForm = function(field, value) {
            state.form[field] = value;
        };

        window.showToast = function(message, type = 'success') {
            window.updateState('ui.toast', { message, type });
            setTimeout(() => window.updateState('ui.toast', null), 3000);
        };

        window.copyToClipboard = function(text, msg) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            window.showToast(msg || 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        };
        
        window.toggleEditSection = function(section) {
            state.ui.expandedSections[section] = !state.ui.expandedSections[section];
            window.render();
        };

        // --- Logic Handlers ---
        window.handleLogin = () => {
            if (state.ui.adminPinInput === ADMIN_PIN) {
                state.ui.isAdmin = true;
                state.ui.showAdminLogin = false;
                state.ui.adminPinInput = '';
                window.showToast('ê´€ë¦¬ìë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.');
            } else {
                window.showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
            }
            window.render();
        };

        window.handleApply = async (e) => {
            e.preventDefault();
            const { name, contact, password, transferred } = state.form;
            const currentCount = state.attendees.filter(a => a.status === 'approved' || (a.status === 'pending' && a.paid)).length;
            const maxCap = parseInt(state.meetupInfo.maxCapacity);
            const isFull = currentCount >= maxCap;

            if (!name.trim()) return window.updateState('ui.errorMsg', 'ì´ë¦„(ì˜ˆê¸ˆì£¼)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if (!isFull && !transferred) return window.updateState('ui.errorMsg', 'ì°¸ê°€ë¹„ë¥¼ ì†¡ê¸ˆí•œ í›„ ì²´í¬í•´ì£¼ì„¸ìš”.');
            if (isFull && !contact.trim()) return window.updateState('ui.errorMsg', 'ëŒ€ê¸° ì‹ ì²­ ì‹œ ì—°ë½ì²˜ ì…ë ¥ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
            if (!password || password.length < 4) return window.updateState('ui.errorMsg', 'ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            window.updateState('ui.loading', true);
            try {
                if (!state.user) {
                     await signInAnonymously(auth);
                }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION), {
                    ...state.form,
                    status: 'pending',
                    isWaitlistApply: isFull,
                    paid: !isFull,
                    createdAt: serverTimestamp(),
                    userId: auth.currentUser?.uid
                });

                if (state.form.rememberMe) {
                    localStorage.setItem('meetup_user_info', JSON.stringify(state.form));
                } else {
                    localStorage.removeItem('meetup_user_info');
                }

                state.form = { name: '', nickname: '', contact: '', password: '', gender: 'female', englishLevel: 'mid', transferred: false, rememberMe: state.form.rememberMe };
                state.ui.errorMsg = '';
                window.showToast(isFull ? 'ëŒ€ê¸°ìë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                console.error(err);
                window.showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
            state.ui.loading = false;
            window.render();
        };

        window.executeApprove = async (id) => {
            if (!state.user) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION, id), { status: 'approved', paid: true });
            state.ui.modalConfig = null;
            window.showToast('ìŠ¹ì¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.render();
        };

        window.executeDelete = async (id) => {
            if (!state.user) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION, id));
            state.ui.modalConfig = null;
            state.ui.showPasswordModal = false;
            state.ui.isCancelMode = false;
            window.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.render();
        };

        window.handleDeleteRequest = (id) => {
            if (state.ui.isAdmin) {
                state.ui.modalConfig = {
                    title: 'ì‚­ì œ í™•ì¸', message: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    confirmText: 'ì‚­ì œí•˜ê¸°', isDestructive: true,
                    onConfirm: `executeDelete('${id}')`
                };
                window.render();
            } else {
                state.ui.targetDeleteId = id;
                state.ui.cancelPasswordInput = '';
                state.ui.showPasswordModal = true;
                window.render();
            }
        };

        window.verifyCancelPassword = () => {
            const target = state.attendees.find(a => a.id === state.ui.targetDeleteId);
            if (target && target.password === state.ui.cancelPasswordInput) {
                window.executeDelete(state.ui.targetDeleteId);
            } else {
                window.showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
                state.ui.cancelPasswordInput = '';
                window.render();
            }
        };

        window.saveInfo = async () => {
            if (!state.user) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', CONFIG_COLLECTION, CONFIG_DOC_ID), state.ui.editForm);
            state.ui.isEditingInfo = false;
            window.showToast('ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.render();
        };

        window.handleImageUpload = (e) => {
             const file = e.target.files[0];
             if(!file) return;
             const reader = new FileReader();
             reader.onloadend = () => {
                 state.ui.editForm.leaderImage = reader.result;
                 window.render();
             };
             reader.readAsDataURL(file);
        };

        window.handleContactChange = (e) => {
            let val = e.target.value.replace(/[^0-9]/g, '');
            if(val.length > 11) val = val.slice(0, 11);
            state.form.contact = val;
            window.render(); // Need to re-render to update state visualization if any
            const input = document.querySelector('input[name="contact"]');
            if (input) {
                input.value = val;
                input.focus();
            }
        };

        window.handleApproveClick = (id) => {
            const count = state.attendees.filter(a => a.status === 'approved').length;
            const max = parseInt(state.meetupInfo.maxCapacity);
            if (count >= max) {
                state.ui.modalConfig = {
                    title: 'ì •ì› ì´ˆê³¼ ìŠ¹ì¸', message: `í˜„ì¬ ì •ì›(${max}ëª…)ì´ ì°¼ìŠµë‹ˆë‹¤. ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    confirmText: 'ì¶”ê°€ ìŠ¹ì¸', isDestructive: false,
                    onConfirm: `executeApprove('${id}')`
                };
                window.render();
            } else {
                window.executeApprove(id);
            }
        };

        window.executeResetAttendees = async () => {
             if(!state.user) return;
             const batch = writeBatch(db);
             state.attendees.forEach(att => {
                 const ref = doc(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION, att.id);
                 batch.delete(ref);
             });
             await batch.commit();
             state.ui.modalConfig = null;
             window.showToast('ëª…ë‹¨ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
             window.render();
        };

        window.handleResetClick = () => {
            state.ui.modalConfig = {
                title: 'ëª…ë‹¨ ì´ˆê¸°í™”', message: 'ëª¨ë“  ì°¸ê°€ì ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)',
                confirmText: 'ì´ˆê¸°í™”', isDestructive: true,
                onConfirm: 'executeResetAttendees()'
            };
            window.render();
        };

        window.downloadCSV = () => {
             if (state.attendees.length === 0) return window.showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
             const BOM = '\uFEFF';
             const headers = ['ì´ë¦„','ë‹‰ë„¤ì„','ì—°ë½ì²˜','ì„±ë³„','ë ˆë²¨','ìƒíƒœ','ì…ê¸ˆ','ì‹ ì²­ì‹œê°„'];
             const rows = state.attendees.map(a => [
                 a.name, a.nickname, a.contact, a.gender, a.englishLevel, a.status, a.paid?'O':'X', 
                 a.createdAt ? new Date(a.createdAt.seconds*1000).toLocaleString() : ''
             ].map(v => `"${String(v||'').replace(/"/g, '""')}"`).join(','));
             
             const blob = new Blob([BOM + headers.join(',') + '\n' + rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = `meetup_${new Date().toISOString().slice(0,10)}.csv`;
             link.click();
        };

        function calculateDDay(dateStr) {
            if (!dateStr) return '';
            try {
                const yearMatch = dateStr.match(/(\d{4})ë…„/);
                const monthMatch = dateStr.match(/(\d{1,2})ì›”/);
                const dayMatch = dateStr.match(/(\d{1,2})ì¼/);
                if (yearMatch && monthMatch && dayMatch) {
                    const target = new Date(yearMatch[1], monthMatch[1] - 1, dayMatch[1]);
                    const today = new Date();
                    target.setHours(0,0,0,0); today.setHours(0,0,0,0);
                    const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                    if (diff === 0) return "D-Day";
                    if (diff > 0) return `D-${diff}`;
                    return "End";
                }
            } catch (e) { return ''; }
            return '';
        }
        
        function getISODateFromKoreanString(koreanDateString) {
            try {
                const matches = koreanDateString.match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
                if (matches) {
                    const y = matches[1];
                    const m = matches[2].padStart(2, '0');
                    const d = matches[3].padStart(2, '0');
                    return `${y}-${m}-${d}`;
                }
            } catch (e) { return ''; }
            return '';
        }

        // --- Template Generator ---
        function App() {
            const { meetupInfo, ui, dDay, attendees, form } = state;
            const currentCount = attendees.filter(a => a.status === 'approved' || (a.status === 'pending' && a.paid)).length;
            const maxCap = parseInt(meetupInfo.maxCapacity);
            const isFull = currentCount >= maxCap;

            const EditSection = (key, title, content) => `
                <div class="border-b border-slate-100 last:border-0">
                    <button onclick="window.toggleEditSection('${key}')" class="w-full flex items-center justify-between p-3 bg-slate-50 font-bold text-slate-700 hover:bg-slate-100">
                        <span>${title}</span>
                        <i data-lucide="${ui.expandedSections[key] ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                    </button>
                    ${ui.expandedSections[key] ? `<div class="p-4 space-y-4 bg-white">${content}</div>` : ''}
                </div>
            `;

            return `
                ${ui.toast ? `
                    <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] animate-in w-full max-w-sm px-4">
                        <div class="shadow-lg rounded-lg p-4 flex items-center gap-3 text-white font-medium ${ui.toast.type === 'error' ? 'bg-red-500' : 'bg-indigo-600'}">
                            ${ui.toast.message}
                        </div>
                    </div>
                ` : ''}

                <header class="bg-indigo-600 text-white p-6 shadow-lg">
                    <div class="max-w-3xl mx-auto flex justify-between items-start">
                        <div>
                            <h1 class="text-3xl font-bold mb-2">${meetupInfo.clubName}</h1>
                            <p class="opacity-90 font-medium text-lg mb-2 flex items-center gap-2">
                                ${dDay ? `<span class="text-xs font-extrabold px-2 py-1 rounded shadow-sm ${dDay==='End'?'bg-slate-200 text-slate-500':'bg-white text-red-600'}">${dDay}</span>` : ''}
                                ${meetupInfo.meetupTitle}
                            </p>
                            <p class="text-indigo-100 text-sm leading-relaxed max-w-xl">${meetupInfo.meetupDesc}</p>
                        </div>
                        ${ui.isAdmin ? `<button onclick="state.ui.editForm = {...state.meetupInfo}; state.ui.isEditingInfo = true; window.render()" class="bg-white/10 p-2 rounded-lg"><i data-lucide="settings"></i></button>` : ''}
                    </div>
                </header>

                <main class="max-w-3xl mx-auto p-4 space-y-6 -mt-6">
                    <!-- Info -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-start gap-4">
                            <div class="bg-indigo-100 p-3 rounded-full text-indigo-600"><i data-lucide="calendar"></i></div>
                            <div>
                                <h3 class="font-semibold text-slate-500 text-sm uppercase">ì¼ì •</h3>
                                <p class="font-bold text-lg">${meetupInfo.date}</p>
                                <p class="text-indigo-600 font-medium">${meetupInfo.time}</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-start gap-4">
                            <div class="bg-emerald-100 p-3 rounded-full text-emerald-600"><i data-lucide="map-pin"></i></div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-slate-500 text-sm uppercase">ì¥ì†Œ</h3>
                                <p class="font-bold text-lg">${meetupInfo.locationName}</p>
                                <p class="text-slate-500 text-sm mb-2">${meetupInfo.locationAddress}</p>
                                <a href="${meetupInfo.locationLink}" target="_blank" class="inline-flex items-center gap-1 text-xs font-bold bg-emerald-50 text-emerald-600 px-2 py-1 rounded shadow-sm">ì§€ë„ë¡œ ë³´ê¸°</a>
                            </div>
                        </div>
                    </div>

                    <!-- Leader Section -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-50 to-white p-4 border-b border-indigo-100 flex items-center gap-2">
                            <i data-lucide="award" class="text-indigo-600"></i>
                            <h2 class="font-bold text-lg text-indigo-900">Meet Your Host</h2>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-col md:flex-row gap-6 items-start">
                                <div class="shrink-0 flex flex-col items-center justify-center w-full md:w-48 bg-slate-50 rounded-xl p-4 border border-slate-100">
                                    <div class="w-24 h-24 md:w-full md:h-auto md:aspect-square rounded-full md:rounded-xl overflow-hidden border-4 border-white shadow-md mb-3">
                                        <img src="${meetupInfo.leaderImage}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="text-center w-full">
                                        <p class="font-bold text-xl text-slate-800">${meetupInfo.leaderName}</p>
                                        <p class="text-xs text-indigo-600 font-bold bg-indigo-100 px-2 py-0.5 rounded-full inline-block mt-1 mb-3">Host Leader</p>
                                        <button onclick="state.ui.isLeaderExpanded = !state.ui.isLeaderExpanded; window.render()" class="md:hidden w-full py-2 flex items-center justify-center gap-1 text-sm font-bold text-slate-500 bg-white border border-slate-200 rounded-lg">
                                            ${ui.isLeaderExpanded ? 'ì ‘ê¸°' : 'ì†Œê°œ ë³´ê¸°'} <i data-lucide="${ui.isLeaderExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex-1 flex flex-col justify-center space-y-5 ${ui.isLeaderExpanded ? 'block' : 'hidden'} md:flex">
                                    <div class="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">${meetupInfo.leaderBio}</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${meetupInfo.leaderTags.split(',').map(tag => `<span class="bg-white text-slate-700 text-xs px-3 py-1.5 rounded-lg font-medium border border-slate-200 shadow-sm">${tag.trim()}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Topic & Curriculum -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2 font-bold text-lg text-indigo-900">
                            <i data-lucide="message-circle" class="text-indigo-600"></i>
                            <h2 class="font-bold text-lg text-indigo-900">ì˜¤ëŠ˜ì˜ ì£¼ì œ</h2>
                        </div>
                        <div class="p-5">
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                                <h4 class="font-bold text-indigo-600 text-sm mb-1">Today's Topic</h4>
                                <p class="text-slate-700 text-sm italic">"${meetupInfo.session2Question}"</p>
                            </div>
                            <button onclick="state.ui.showCurriculum = !state.ui.showCurriculum; window.render()" class="w-full flex items-center justify-between p-3 bg-indigo-50 text-indigo-700 font-bold rounded-lg hover:bg-indigo-100 transition-colors">
                                <span><i data-lucide="book-open" class="inline-flex w-4 h-4 mr-1"></i> ì§„í–‰ ë°©ì‹ ìì„¸íˆ ë³´ê¸°</span>
                                <i data-lucide="${ui.showCurriculum ? 'chevron-up' : 'chevron-down'}"></i>
                            </button>
                            ${ui.showCurriculum ? `
                                <div class="mt-6 space-y-6 animate-in">
                                    <div class="pl-4 border-l-2 border-indigo-200">
                                        <h3 class="font-bold text-indigo-800">${meetupInfo.part1Title} (${meetupInfo.part1Duration})</h3>
                                        <div class="mt-2 space-y-3">
                                            ${[1,2,3].map(i => meetupInfo[`p1Title${i}`] ? `<div><span class="text-xs font-bold text-indigo-600">${meetupInfo[`p1Time${i}`]}</span> <span class="font-bold ml-1 text-sm">${meetupInfo[`p1Title${i}`]}</span><p class="text-xs text-slate-500 ml-5">${meetupInfo[`p1Desc${i}`]}</p></div>` : '').join('')}
                                        </div>
                                    </div>
                                    <div class="bg-amber-50 p-3 rounded text-sm text-amber-800 font-bold border border-amber-100">
                                        â˜• ${meetupInfo.breakTitle}: ${meetupInfo.breakDesc}
                                    </div>
                                    <div class="pl-4 border-l-2 border-indigo-200">
                                        <h3 class="font-bold text-indigo-800">${meetupInfo.part2Title} (${meetupInfo.part2Duration})</h3>
                                        <div class="mt-2 space-y-3">
                                            ${[1,2,3].map(i => meetupInfo[`p2Title${i}`] ? `<div><span class="text-xs font-bold text-indigo-600">${meetupInfo[`p2Time${i}`]}</span> <span class="font-bold ml-1 text-sm">${meetupInfo[`p2Title${i}`]}</span><p class="text-xs text-slate-500 ml-5">${meetupInfo[`p2Desc${i}`]}</p></div>` : '').join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 ${isFull ? 'border-orange-500' : 'border-indigo-500'}">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="send" class="${isFull ? 'text-orange-500' : 'text-indigo-500'}"></i>
                            ${isFull ? 'ëŒ€ê¸° ì‹ ì²­' : 'ì°¸ê°€ ì‹ ì²­'}
                        </h2>
                        
                        <div class="mb-6 p-4 rounded text-sm ${isFull ? 'bg-orange-50 text-orange-900' : 'bg-indigo-50 text-indigo-900'}">
                            ${isFull ? `<p class="font-bold">í˜„ì¬ ì •ì›(${maxCap}ëª…)ì´ ë§ˆê°ë˜ì–´ ëŒ€ê¸°ìë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤. ì·¨ì†Œì ë°œìƒ ì‹œ ê°œë³„ ì—°ë½ ë“œë¦½ë‹ˆë‹¤.</p>` : `
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="font-bold">ì°¸ê°€ë¹„:</span>
                                    <span class="text-red-600 font-bold text-lg">${meetupInfo.fee}ì›</span>
                                    <span class="text-slate-400 line-through text-xs font-normal">${meetupInfo.originalFee}ì›</span>
                                </div>
                                <p class="mb-1">${meetupInfo.bankName} ${meetupInfo.bankAccount} (${meetupInfo.accountHolder})</p>
                                <button onclick="copyToClipboard('${meetupInfo.bankAccount}', 'ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.')" class="text-xs font-bold text-indigo-600 border border-indigo-200 px-2 py-1 rounded bg-white hover:bg-indigo-50 transition-colors">ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬</button>
                                <p class="text-[10px] mt-2 opacity-70">${meetupInfo.drinkPolicy}</p>
                                <p class="text-[10px] mt-1 text-red-500 font-bold">ğŸš« ì°¸ê°€ ì·¨ì†Œ ì‹œ ì°¸ê°€ë¹„ëŠ” í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                            `}
                        </div>

                        <form onsubmit="window.handleApply(event)" class="space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1 flex items-center gap-1.5">
                                    <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i> ì…ê¸ˆì ì„±í•¨
                                </label>
                                <input type="text" value="${form.name}" oninput="window.updateForm('name', this.value)" placeholder="ì˜ˆê¸ˆì£¼ ëª…ê³¼ ë™ì¼í•˜ê²Œ ì…ë ¥" class="w-full p-3 border rounded-lg transition-all">
                                <p class="text-[10px] text-slate-500 mt-1 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> ì…ê¸ˆ í™•ì¸ì„ ìœ„í•´ ë°˜ë“œì‹œ ì‹¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
                            </div>
                            ${isFull ? `
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1 flex items-center gap-1.5"><i data-lucide="phone" class="w-4 h-4 text-indigo-600"></i> ì—°ë½ì²˜</label>
                                    <input type="tel" name="contact" value="${form.contact}" oninput="window.handleContactChange(event)" placeholder="010-0000-0000" class="w-full p-3 border rounded-lg">
                                    <p class="text-[10px] text-orange-600 mt-1 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> ë¹ˆ ìë¦¬ê°€ ìƒê¸°ë©´ ì´ ë²ˆí˜¸ë¡œ ì—°ë½ë“œë¦½ë‹ˆë‹¤.</p>
                                </div>
                            ` : ''}
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1 flex items-center gap-1.5">
                                    <i data-lucide="smile" class="w-4 h-4 text-indigo-600"></i> ì˜ì–´ ì´ë¦„ (ë‹‰ë„¤ì„)
                                </label>
                                <input type="text" value="${form.nickname}" oninput="window.updateForm('nickname', this.value)" placeholder="ëª…ë‹¨ì— í‘œì‹œë  ì´ë¦„" class="w-full p-3 border rounded-lg">
                                <p class="text-[10px] text-slate-500 mt-1 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> ì°¸ê°€ í™•ì • ëª…ë‹¨ì—ëŠ” ì´ ì´ë¦„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-1"><i data-lucide="users" class="w-4 h-4 text-indigo-600"></i> ì„±ë³„</label>
                                <div class="flex gap-3">
                                    <label class="flex-1 border rounded-lg p-3 flex justify-center gap-2 cursor-pointer transition-colors ${form.gender==='male'?'bg-indigo-50 border-indigo-500 text-indigo-700 font-bold':''}">
                                        <input type="radio" name="gender" value="male" class="hidden" onclick="state.form.gender='male'; window.render()" ${form.gender==='male'?'checked':''}> ğŸ‘¨ ë‚¨ì„±
                                    </label>
                                    <label class="flex-1 border rounded-lg p-3 flex justify-center gap-2 cursor-pointer transition-colors ${form.gender==='female'?'bg-indigo-50 border-indigo-500 text-indigo-700 font-bold':''}">
                                        <input type="radio" name="gender" value="female" class="hidden" onclick="state.form.gender='female'; window.render()" ${form.gender==='female'?'checked':''}> ğŸ‘© ì—¬ì„±
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-1.5">
                                    <i data-lucide="activity" class="w-4 h-4 text-indigo-600"></i> ì˜ì–´ ì‹¤ë ¥ ë ˆë²¨
                                </label>
                                <div class="grid gap-2">
                                    ${['low-mid|ì¤‘í•˜ (Lower Intermediate)|ë¬¸ì¥ êµ¬ì„±ì´ ì„œíˆ´ì§€ë§Œ ì†Œí†µ ê°€ëŠ¥', 'mid|ì¤‘ (Intermediate)|ì¼ìƒì ì¸ ì£¼ì œë¡œ ëŒ€í™” ê°€ëŠ¥', 'mid-high|ì¤‘ìƒ (Upper Intermediate)|ë‹¤ì–‘í•œ ì£¼ì œë¡œ ì˜ê²¬ í‘œí˜„ ê°€ëŠ¥', 'high|ìƒ (Advanced)|ë§‰í˜ì—†ì´ ììœ ë¡œìš´ í† ë¡  ê°€ëŠ¥'].map(lv => {
                                        const [v, l, d] = lv.split('|');
                                        return `<label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition-all ${form.englishLevel===v ? 'bg-indigo-50 border-indigo-500 text-indigo-700 font-bold' : 'hover:bg-slate-50'}">
                                            <input type="radio" name="level" value="${v}" onclick="state.form.englishLevel='${v}'; window.render()" ${form.englishLevel===v?'checked':''} class="accent-indigo-600">
                                            <div class="flex flex-col">
                                                <span class="text-sm">${l}</span>
                                                <span class="text-[10px] text-slate-400 font-normal">${d}</span>
                                            </div>
                                        </label>`;
                                    }).join('')}
                                </div>
                                <p class="text-[10px] text-slate-500 mt-2 flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> ì„±ë³„ê³¼ ì˜ì–´ ì‹¤ë ¥ì€ íŒ€ë¹Œë”© ì‹œ í™œìš©ë©ë‹ˆë‹¤.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-1.5">
                                    <i data-lucide="lock" class="w-4 h-4 text-indigo-600"></i> ì·¨ì†Œ ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)
                                </label>
                                <input type="tel" maxlength="4" value="${form.password}" oninput="window.updateForm('password', this.value.replace(/[^0-9]/g,''))" placeholder="****" class="w-full p-3 border rounded-lg tracking-widest text-center text-xl shadow-inner bg-slate-50">
                                <p class="text-[10px] text-center text-slate-400 mt-1 flex items-center justify-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> ë³¸ì¸ì´ ì‹ ì²­ ë‚´ì—­ì„ ì·¨ì†Œí•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
                            </div>
                            
                            <div class="space-y-2">
                                ${!isFull ? `
                                    <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                        <input type="checkbox" ${form.transferred?'checked':''} onclick="state.form.transferred=this.checked; window.render()" class="w-5 h-5 accent-indigo-600 rounded">
                                        <span class="text-sm font-medium">ì°¸ê°€ë¹„ ì†¡ê¸ˆì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.</span>
                                    </label>
                                ` : ''}
                                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                    <input type="checkbox" ${form.rememberMe?'checked':''} onclick="state.form.rememberMe=this.checked; window.render()" class="w-5 h-5 accent-indigo-600 rounded">
                                    <span class="text-sm font-medium">ë‚´ ì •ë³´ ê¸°ì–µí•˜ê¸° (ìë™ì…ë ¥)</span>
                                </label>
                            </div>

                            ${ui.errorMsg ? `<p class="text-red-500 text-xs font-bold text-center animate-pulse">${ui.errorMsg}</p>` : ''}
                            <button type="submit" class="w-full text-white font-bold py-3 rounded-lg shadow-md transition-all active:scale-95 ${isFull ? 'bg-orange-500 hover:bg-orange-600' : 'bg-indigo-600 hover:bg-indigo-700'}">
                                ${ui.loading ? 'ì²˜ë¦¬ ì¤‘...' : (isFull ? 'ëŒ€ê¸° ëª…ë‹¨ ì ‘ìˆ˜í•˜ê¸°' : 'ì°¸ê°€ ì‹ ì²­í•˜ê¸°')}
                            </button>
                        </form>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold flex gap-2 items-center"><i data-lucide="users" class="text-emerald-600"></i> ì°¸ì—¬ í˜„í™© (${currentCount}/${maxCap})</h2>
                            <button onclick="state.ui.isCancelMode = !state.ui.isCancelMode; window.render()" class="text-xs px-2 py-1 rounded font-bold border transition-colors ${ui.isCancelMode ? 'bg-slate-800 text-white' : 'bg-white text-slate-500 border-slate-300'}">
                                ${ui.isCancelMode ? 'ì·¨ì†Œ ëª¨ë“œ ì¢…ë£Œ' : 'ë‚´ ì‹ ì²­ ì·¨ì†Œ'}
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 bg-slate-100 p-2 rounded border flex items-center gap-1 break-keep">
                            <i data-lucide="info" class="shrink-0 w-3 h-3"></i> ì˜ì–´ ì‹¤ë ¥ê³¼ ì„±ë³„ì— ê´€ê³„ì—†ì´ ì„ ì°©ìˆœìœ¼ë¡œ ì°¸ì„ í™•ì •ë©ë‹ˆë‹¤.
                        </p>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 divide-y divide-slate-100">
                            ${attendees.length === 0 ? '<div class="p-10 text-center text-slate-400">ì•„ì§ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>' : attendees.map(att => `
                                <div class="p-4 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">${(att.nickname || att.name).charAt(0)}</div>
                                        <div>
                                            <p class="font-bold text-slate-800 flex items-center gap-1">
                                                ${att.nickname || att.name}
                                                ${state.user?.uid === att.userId ? '<span class="text-[10px] bg-indigo-100 text-indigo-600 px-1 rounded">ë‚˜</span>' : ''}
                                            </p>
                                            <p class="text-xs text-slate-500">
                                                ${att.status === 'approved' ? '<span class="text-emerald-600 font-bold">ì°¸ê°€ í™•ì •</span>' : 
                                                  att.isWaitlistApply ? '<span class="text-orange-600 font-bold">ëŒ€ê¸° ì¤‘</span>' : '<span class="text-amber-600">ì…ê¸ˆ í™•ì¸ ì¤‘</span>'}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        ${(ui.isAdmin || (ui.isCancelMode && state.user?.uid === att.userId)) ? 
                                            `<button onclick="window.handleDeleteRequest('${att.id}')" class="text-red-400 hover:text-red-600 p-2" title="ì·¨ì†Œ/ì‚­ì œ"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
                                        ${ui.isAdmin && att.status !== 'approved' ? 
                                            `<button onclick="window.handleApproveClick('${att.id}')" class="text-emerald-500 hover:text-emerald-700 p-2" title="ìŠ¹ì¸"><i data-lucide="check-circle" class="w-5 h-5"></i></button>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2 font-bold text-lg text-indigo-900">
                            <i data-lucide="shield-check" class="text-indigo-600"></i> í´ëŸ½ ì—í‹°ì¼“
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${[1,2,3].map(i => `
                                <div class="p-4">
                                    <h4 class="font-bold text-slate-700 text-sm mb-1">${meetupInfo[`etiquette${i}Title`]}</h4>
                                    <p class="text-xs text-slate-500 leading-relaxed">${meetupInfo[`etiquette${i}Desc`]}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2 font-bold text-lg text-indigo-900">
                            <i data-lucide="help-circle" class="text-indigo-600"></i> ìì£¼ ë¬»ëŠ” ì§ˆë¬¸
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${[1,2,3].map(i => `
                                <div>
                                    <button onclick="state.ui.activeFaq = state.ui.activeFaq === ${i} ? null : ${i}; window.render()" class="w-full p-4 text-left flex justify-between font-bold text-slate-700 hover:bg-slate-50 transition-colors">
                                        <span class="text-sm"><span class="text-indigo-500 mr-1">Q.</span> ${meetupInfo[`faq${i}Q`]}</span>
                                        <i data-lucide="${ui.activeFaq === i ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 text-slate-400"></i>
                                    </button>
                                    ${ui.activeFaq === i ? `<div class="p-4 pt-0 text-xs text-slate-600 bg-slate-50 leading-relaxed animate-in"><span class="font-bold text-emerald-600 mr-1">A.</span> ${meetupInfo[`faq${i}A`]}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${ui.isAdmin ? `
                        <div class="bg-amber-50 p-6 rounded-xl border-2 border-amber-200 space-y-4">
                            <h3 class="font-bold text-amber-800 flex items-center gap-2"><i data-lucide="shield"></i> ê´€ë¦¬ì íŒ¨ë„</h3>
                            <button onclick="window.downloadCSV()" class="w-full py-2 bg-white border border-emerald-300 text-emerald-700 font-bold rounded-lg flex items-center justify-center gap-2">ëª…ë‹¨ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="window.handleResetClick()" class="w-full py-2 bg-red-100 text-red-700 font-bold rounded-lg flex items-center justify-center gap-2">ì „ì²´ ëª…ë‹¨ ì´ˆê¸°í™”</button>
                        </div>
                    ` : ''}
                </main>

                <footer class="max-w-3xl mx-auto mt-12 px-4 flex justify-between items-center text-slate-400 text-xs pb-10">
                    <p>Â© 2026 ${meetupInfo.clubName}</p>
                    <button onclick="state.ui.isAdmin ? (state.ui.isAdmin=false, window.showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.')) : state.ui.showAdminLogin=true; window.render()" class="hover:underline transition-all">
                        ${ui.isAdmin ? 'ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ' : 'ê´€ë¦¬ì ë¡œê·¸ì¸'}
                    </button>
                </footer>

                <!-- Admin Login Modal -->
                ${ui.showAdminLogin ? `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[80] p-4">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                            <h3 class="font-bold text-lg mb-4 text-center">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
                            <input type="password" oninput="state.ui.adminPinInput=this.value" class="w-full p-3 border rounded-lg mb-4 text-center tracking-widest outline-none focus:ring-2 focus:ring-indigo-600" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autofocus>
                            <div class="flex gap-2">
                                <button onclick="state.ui.showAdminLogin=false; window.render()" class="flex-1 py-2 bg-slate-100 rounded-lg font-bold">ì·¨ì†Œ</button>
                                <button onclick="window.handleLogin()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-bold">í™•ì¸</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Delete Confirm Modal -->
                ${ui.showPasswordModal ? `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[80] p-4">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                            <h3 class="font-bold text-lg mb-4">ì‹ ì²­ ì·¨ì†Œ</h3>
                            <p class="text-sm text-slate-600 mb-4 text-center">ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                            <input type="password" maxlength="4" oninput="state.ui.cancelPasswordInput=this.value" class="w-full p-3 border rounded-lg mb-4 text-center text-xl tracking-widest outline-none focus:ring-2 focus:ring-red-500" autofocus>
                            <div class="flex gap-2">
                                <button onclick="state.ui.showPasswordModal=false; window.render()" class="flex-1 py-2 bg-slate-100 rounded-lg font-bold">ë‹«ê¸°</button>
                                <button onclick="window.verifyCancelPassword()" class="flex-1 py-2 bg-red-500 text-white rounded-lg font-bold">í™•ì¸</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- General Modal (Reset/Approve) -->
                ${ui.modalConfig ? `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[90] p-4">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                            <h3 class="font-bold text-lg mb-2">${ui.modalConfig.title}</h3>
                            <p class="text-sm text-slate-600 mb-6">${ui.modalConfig.message}</p>
                            <div class="flex gap-2">
                                <button onclick="state.ui.modalConfig=null; window.render()" class="flex-1 py-2 bg-slate-100 rounded-lg font-bold">ì·¨ì†Œ</button>
                                <button onclick="window.${ui.modalConfig.onConfirm}" class="flex-1 py-2 text-white rounded-lg font-bold ${ui.modalConfig.isDestructive?'bg-red-500':'bg-indigo-600'}">${ui.modalConfig.confirmText}</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Settings Modal -->
                ${ui.isEditingInfo ? `
                    <div class="fixed inset-0 bg-black/60 z-[70] flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-xl sm:rounded-xl w-full max-w-lg flex flex-col max-h-[90vh]">
                            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                                <h3 class="font-bold flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> ëª¨ì„ ì •ë³´ ìˆ˜ì •</h3>
                                <button onclick="state.ui.isEditingInfo=false; window.render()"><i data-lucide="x"></i></button>
                            </div>
                            <div class="overflow-y-auto no-scrollbar">
                                ${EditSection('header', '1. í—¤ë” ì„¤ì • (Header)', `
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ëª¨ì„ ì´ë¦„</label><input type="text" value="${ui.editForm.clubName}" oninput="state.ui.editForm.clubName=this.value" class="w-full border p-2 rounded"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ë©”ì¸ íƒ€ì´í‹€</label><input type="text" value="${ui.editForm.meetupTitle}" oninput="state.ui.editForm.meetupTitle=this.value" class="w-full border p-2 rounded"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ëª¨ì„ ì„¤ëª…</label><textarea oninput="state.ui.editForm.meetupDesc=this.value" class="w-full border p-2 rounded h-16">${ui.editForm.meetupDesc}</textarea></div>
                                `)}
                                ${EditSection('basic', '2. ê¸°ë³¸ ì •ë³´ (Date, Time, Location)', `
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="block text-xs font-bold text-slate-500 mb-1">ë‚ ì§œ</label><input type="text" value="${ui.editForm.date}" oninput="state.ui.editForm.date=this.value" class="w-full border p-2 rounded"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 mb-1">ì‹œê°„</label><input type="text" value="${ui.editForm.time}" oninput="state.ui.editForm.time=this.value" class="w-full border p-2 rounded"></div>
                                    </div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ì¥ì†Œëª…</label><input type="text" value="${ui.editForm.locationName}" oninput="state.ui.editForm.locationName=this.value" class="w-full border p-2 rounded"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ì£¼ì†Œ</label><input type="text" value="${ui.editForm.locationAddress}" oninput="state.ui.editForm.locationAddress=this.value" class="w-full border p-2 rounded"></div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div><label class="block text-xs font-bold text-slate-500 mb-1">ì •ì›</label><input type="number" value="${ui.editForm.maxCapacity}" oninput="state.ui.editForm.maxCapacity=this.value" class="w-full border p-2 rounded"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 mb-1">ì°¸ê°€ë¹„</label><input type="text" value="${ui.editForm.fee}" oninput="state.ui.editForm.fee=this.value" class="w-full border p-2 rounded"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 mb-1">ê¸°ì¡´ê°€</label><input type="text" value="${ui.editForm.originalFee}" oninput="state.ui.editForm.originalFee=this.value" class="w-full border p-2 rounded"></div>
                                    </div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ì€í–‰</label><input type="text" value="${ui.editForm.bankName}" oninput="state.ui.editForm.bankName=this.value" class="w-full border p-2 rounded"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ê³„ì¢Œë²ˆí˜¸</label><input type="text" value="${ui.editForm.bankAccount}" oninput="state.ui.editForm.bankAccount=this.value" class="w-full border p-2 rounded"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ì˜ˆê¸ˆì£¼</label><input type="text" value="${ui.editForm.accountHolder}" oninput="state.ui.editForm.accountHolder=this.value" class="w-full border p-2 rounded"></div>
                                `)}
                                ${EditSection('curriculum', '3. ì»¤ë¦¬í˜ëŸ¼ (Curriculum)', `
                                    <div class="space-y-2">
                                        <input type="text" placeholder="Part 1 Title" value="${ui.editForm.part1Title}" oninput="state.ui.editForm.part1Title=this.value" class="w-full border p-2 rounded font-bold">
                                        ${[1,2,3].map(i => `<div class="flex gap-1"><input class="w-16 border p-1 rounded text-xs" placeholder="Time" value="${ui.editForm['p1Time'+i]||''}" oninput="state.ui.editForm['p1Time${i}']=this.value"><input class="flex-1 border p-1 rounded text-xs" placeholder="Item" value="${ui.editForm['p1Title'+i]||''}" oninput="state.ui.editForm['p1Title${i}']=this.value"></div>`).join('')}
                                        <hr/>
                                        <input type="text" placeholder="Part 2 Title" value="${ui.editForm.part2Title}" oninput="state.ui.editForm.part2Title=this.value" class="w-full border p-2 rounded font-bold">
                                        ${[1,2,3].map(i => `<div class="flex gap-1"><input class="w-16 border p-1 rounded text-xs" placeholder="Time" value="${ui.editForm['p2Time'+i]||''}" oninput="state.ui.editForm['p2Time${i}']=this.value"><input class="flex-1 border p-1 rounded text-xs" placeholder="Item" value="${ui.editForm['p2Title'+i]||''}" oninput="state.ui.editForm['p2Title${i}']=this.value"></div>`).join('')}
                                    </div>
                                `)}
                                ${EditSection('topic', '4. ì£¼ì œ (Topic)', `
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ëŒ€ì£¼ì œ</label><input type="text" value="${ui.editForm.topicTitle}" oninput="state.ui.editForm.topicTitle=this.value" class="w-full border p-2 rounded"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">í† ë¡  ì£¼ì œ ì§ˆë¬¸</label><textarea oninput="state.ui.editForm.session2Question=this.value" class="w-full border p-2 rounded h-24 text-sm">${ui.editForm.session2Question}</textarea></div>
                                `)}
                                ${EditSection('leader', '5. ë¦¬ë” ë° ê¸°íƒ€', `
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ë¦¬ë” ì´ë¦„</label><input type="text" value="${ui.editForm.leaderName}" oninput="state.ui.editForm.leaderName=this.value" class="w-full border p-2 rounded"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ë¦¬ë” ì´ë¯¸ì§€</label><input type="text" value="${ui.editForm.leaderImage}" oninput="state.ui.editForm.leaderImage=this.value" class="w-full border p-2 rounded text-xs mb-1">
                                    <input type="file" id="leaderImageInput" accept="image/*" class="w-full text-xs"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ë¦¬ë” ì†Œê°œ</label><textarea oninput="state.ui.editForm.leaderBio=this.value" class="w-full border p-2 rounded h-24 text-sm">${ui.editForm.leaderBio}</textarea></div>
                                `)}
                            </div>
                            <div class="p-4 border-t flex gap-2 bg-slate-50 rounded-b-xl">
                                <button onclick="state.ui.isEditingInfo=false; window.render()" class="flex-1 py-3 border rounded-lg font-bold">ì·¨ì†Œ</button>
                                <button onclick="window.saveInfo()" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold shadow-md">ì €ì¥í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // --- Firebase Listeners & Auth ---
        const startListeners = () => {
            // Path must be even: artifacts/appId/public/data/collectionName/docId
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', CONFIG_COLLECTION, CONFIG_DOC_ID), (snap) => {
                if (snap.exists()) {
                    state.meetupInfo = { ...state.meetupInfo, ...snap.data() };
                    state.dDay = calculateDDay(state.meetupInfo.date);
                    window.render();
                }
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', ATTENDEES_COLLECTION), (snap) => {
                const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                state.attendees = data.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                window.render();
            });
        };

        const init = async () => {
            const saved = localStorage.getItem('meetup_user_info');
            if (saved) {
                state.form = { ...state.form, ...JSON.parse(saved), rememberMe: true };
            }

            onAuthStateChanged(auth, async (u) => {
                state.user = u;
                if (u) {
                    // Only start listeners if authenticated
                    startListeners();
                } else {
                    // Try to sign in if not authenticated
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                             await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth Failed:", e);
                    }
                }
                window.render();
            });
        };

        init();
    </script>
</body>
</html>
